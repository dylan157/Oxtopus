<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Octopus Agile - Extended with UK Energy Mix</title>

  <!-- OPTIONAL: Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap"
    rel="stylesheet"
  />

  <style>
    /* =============================
       BASE / DARK THEME
       ============================= */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      min-height: 100vh;
      background-color: #1E0D35; /* Dark purple */
      color: #FFFFFF;
      font-family: 'Roboto', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      width: 95%;
      max-width: 1000px;
      background-color: #2B1240;
      border-radius: 8px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      animation: fadeIn 0.8s ease-in-out;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-4px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* =============================
       HEADER
       ============================= */
    .header {
      text-align: center;
    }
    .header h1 {
      font-size: 1.8rem;
      color: #FF00E5;
      margin-bottom: 8px;
    }
    .header p {
      font-size: 0.9rem;
      color: #CCCCCC;
    }

    .region-selector {
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .region-selector label {
      font-size: 0.9rem;
      color: #FF00E5;
    }
    .region-selector select {
      padding: 5px 10px;
      border-radius: 4px;
      border: 1px solid #999;
      background-color: #3A1D50;
      color: #FFFFFF;
    }
    .region-selector select:focus {
      outline: 1px solid #FF00E5;
    }

    /* =============================
       CURRENT PRICE
       ============================= */
    .current-price {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 16px;
      text-align: center;
    }
    .current-price .price-display {
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: 5px;
    }
    .current-price .timestamp {
      font-size: 0.9rem;
      color: #BBBBBB;
    }

    /* =============================
       METRICS
       ============================= */
    .metrics {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 16px;
    }
    .metrics-title {
      font-size: 1.2rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 10px;
      color: #FF00E5;
    }
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .metric-item {
      background-color: #4A2E60;
      border-radius: 6px;
      padding: 10px;
      text-align: center;
    }
    .metric-item h2 {
      font-size: 1rem;
      color: #FF00E5;
      margin-bottom: 6px;
    }
    .metric-item p {
      font-size: 1rem;
    }

    /* =============================
       PRICE TABLE
       ============================= */
    .price-table {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 16px;
    }
    .price-table-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
      color: #FF00E5;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    thead {
      background-color: #4A2E60;
    }
    thead th {
      padding: 8px;
      font-size: 0.9rem;
      font-weight: 700;
      color: #FFFFFF;
    }
    tbody tr {
      border-bottom: 1px solid #4A2E60;
    }
    tbody tr:hover {
      background-color: #5B3E70;
    }
    td {
      padding: 8px;
      font-size: 0.9rem;
      text-align: center;
      color: #FFFFFF;
    }
    /* color-coded intervals: <15 => green, <25 => orange, else => red */
    .price-good {
      background-color: rgba(0, 255, 0, 0.2);
    }
    .price-ok {
      background-color: rgba(255, 165, 0, 0.2);
    }
    .price-bad {
      background-color: rgba(255, 0, 0, 0.2);
    }

    /* =============================
       TOMORROW PREVIEW
       ============================= */
    .tomorrow {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 16px;
      text-align: center;
    }
    .tomorrow-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      color: #FF00E5;
    }

    /* =============================
       DEBUG
       ============================= */
    .debug {
      background-color: rgba(255, 0, 0, 0.1);
      color: #ff8080;
      font-size: 0.8rem;
      padding: 10px;
      border-radius: 6px;
      display: none;
      word-wrap: break-word;
    }

    /* =============================
       CHART WITH GRID LINES
       ============================= */
    .chart-section {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 16px;
      position: relative;
    }
    .chart-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
      color: #FF00E5;
    }
    .chart-container {
      position: relative;
      width: 100%;
      height: 300px; 
      background-color: #4A2E60;
      border-radius: 6px;
      overflow: hidden; /* in case we draw near edges */
    }

    /* =============================
       ENERGY MIX SECTION
       ============================= */
    .energy-mix {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 16px;
    }
    .energy-mix-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
      color: #FF00E5;
    }
    .mix-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .mix-item {
      background-color: #4A2E60;
      border-radius: 6px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .mix-item h3 {
      font-size: 1rem;
      color: #FF00E5;
      margin: 0;
    }
    .mix-bar-container {
      background-color: #3A1D50;
      border-radius: 4px;
      height: 10px;
      width: 100%;
      position: relative;
      overflow: hidden;
    }
    .mix-bar {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      background-color: #FF00E5; /* Pink bar */
    }
    .mix-perc {
      font-size: 0.9rem;
      color: #FFFFFF;
    }

    /* Responsive for small screens */
    @media (max-width: 768px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }
      .mix-grid {
        grid-template-columns: 1fr;
      }
      table thead, table tbody {
        font-size: 0.8rem;
      }
    }
    @media (max-width: 480px) {
      .header h1 {
        font-size: 1.4rem;
      }
      .price-display {
        font-size: 1.4rem;
      }
      .metrics-title, .price-table-title, .tomorrow-title, .chart-title, .energy-mix-title {
        font-size: 1.0rem;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- HEADER -->
    <div class="header">
      <h1>Octopus Agile - Extended with UK Energy Mix</h1>
      <p>See your region’s Agile prices, plus the current National Grid fuel mix.</p>
      <div class="region-selector">
        <label for="regionSelect">Region:</label>
        <select id="regionSelect">
          <option value="A">A (Eastern England)</option>
          <option value="B">B (East Midlands)</option>
          <option value="C">C (London)</option>
          <option value="D">D (Merseyside/N. Wales)</option>
          <option value="E">E (West Midlands)</option>
          <option value="F">F (N. Eastern Eng.)</option>
          <option value="G">G (North Western)</option>
          <option value="H">H (Southern Eng.)</option>
          <option value="J">J (South Eastern)</option>
          <option value="K">K (Southern Scotland)</option>
          <option value="L">L (Northern Scotland)</option>
          <option value="M">M (South Wales)</option>
          <option value="N">N (South Western)</option>
          <option value="P">P (Yorkshire)</option>
        </select>
      </div>
    </div>

    <!-- CURRENT PRICE -->
    <div class="current-price">
      <div id="priceDisplay" class="price-display">Loading price...</div>
      <div id="timestampDisplay" class="timestamp"></div>
    </div>

    <!-- METRICS -->
    <div class="metrics">
      <div class="metrics-title">Today’s Summary</div>
      <div class="metrics-grid">
        <div class="metric-item">
          <h2>Min Price</h2>
          <p id="minPrice">-</p>
        </div>
        <div class="metric-item">
          <h2>Max Price</h2>
          <p id="maxPrice">-</p>
        </div>
        <div class="metric-item">
          <h2>Average</h2>
          <p id="avgPrice">-</p>
        </div>
      </div>
    </div>

    <!-- CHART -->
    <div class="chart-section">
      <div class="chart-title">Today’s Price Chart</div>
      <div class="chart-container" id="chartContainer">
        <!-- We’ll draw manually with JS -->
      </div>
    </div>

    <!-- PRICE TABLE -->
    <div class="price-table">
      <div class="price-table-title">Half-Hourly Prices (Today)</div>
      <table>
        <thead>
          <tr>
            <th>From</th>
            <th>To</th>
            <th>Price (p/kWh)</th>
          </tr>
        </thead>
        <tbody id="priceTableBody"></tbody>
      </table>
    </div>

    <!-- TOMORROW PREVIEW -->
    <div class="tomorrow">
      <div class="tomorrow-title">Tomorrow’s Preview</div>
      <div id="tomorrowInfo">Checking tomorrow’s data...</div>
    </div>

    <!-- NATIONAL GRID ENERGY MIX -->
    <div class="energy-mix">
      <div class="energy-mix-title">Current UK Energy Mix</div>
      <div id="energyMixContainer">
        <!-- We'll display a grid of sources here -->
      </div>
    </div>

    <!-- DEBUG -->
    <div id="debugLog" class="debug"></div>
  </div>

  <script>
    /**********************************************************************************************
     *                               GLOBAL VARIABLES & DOM REFS
     **********************************************************************************************/
    const API_BASE = 'https://api.octopus.energy/v1/products/AGILE-18-02-21';
    // carbonintensity.org.uk for "fuel" breakdown
    const GENERATION_MIX_API = 'https://api.carbonintensity.org.uk/generation';

    let regionCode = 'A'; // default
    let todayData = [];
    let tomorrowData = [];

    // DOM
    const regionSelectEl   = document.getElementById('regionSelect');
    const priceEl          = document.getElementById('priceDisplay');
    const timestampEl      = document.getElementById('timestampDisplay');
    const minPriceEl       = document.getElementById('minPrice');
    const maxPriceEl       = document.getElementById('maxPrice');
    const avgPriceEl       = document.getElementById('avgPrice');
    const priceTableBodyEl = document.getElementById('priceTableBody');
    const tomorrowInfoEl   = document.getElementById('tomorrowInfo');
    const debugLogEl       = document.getElementById('debugLog');
    const chartContainerEl = document.getElementById('chartContainer');
    const energyMixContainerEl = document.getElementById('energyMixContainer');

    /**********************************************************************************************
     *                                      LISTENERS
     **********************************************************************************************/
    regionSelectEl.addEventListener('change', () => {
      regionCode = regionSelectEl.value;
      fetchAndRenderAll();
    });

    /**********************************************************************************************
     *                         FETCH OCTOPUS AGILE DATA
     **********************************************************************************************/
    async function fetchAgileData() {
      const url = `${API_BASE}/electricity-tariffs/E-1R-AGILE-18-02-21-${regionCode}/standard-unit-rates/`;
      try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`HTTP error: ${resp.status}`);
        return resp.json();
      } catch (err) {
        throw err;
      }
    }

    function splitTodayAndTomorrow(results) {
      todayData = [];
      tomorrowData = [];

      const now = new Date();
      const todayStr = formatDateYYYYMMDD(now);

      const tomorrowDate = new Date(now);
      tomorrowDate.setDate(now.getDate() + 1);
      const tomorrowStr = formatDateYYYYMMDD(tomorrowDate);

      results.sort((a,b) => new Date(a.valid_from) - new Date(b.valid_from));
      results.forEach(item => {
        const d = new Date(item.valid_from);
        const dStr = formatDateYYYYMMDD(d);
        if (dStr === todayStr) {
          todayData.push(item);
        } else if (dStr === tomorrowStr) {
          tomorrowData.push(item);
        }
      });
    }

    function formatDateYYYYMMDD(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    /**********************************************************************************************
     *                            RENDER CURRENT PRICE
     **********************************************************************************************/
    function renderCurrentPrice() {
      const now = new Date();
      const currentPeriod = todayData.find(item => {
        const start = new Date(item.valid_from);
        const end   = new Date(item.valid_to);
        return start <= now && end > now;
      });
      if (!currentPeriod) {
        priceEl.innerText = 'No current price data.';
        timestampEl.innerText = '';
        return;
      }
      const pStr = currentPeriod.value_inc_vat.toFixed(2);
      priceEl.innerText = `Current Price: ${pStr} p/kWh`;

      const startStr = new Date(currentPeriod.valid_from)
        .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const endStr   = new Date(currentPeriod.valid_to)
        .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      timestampEl.innerText = `Valid: ${startStr} - ${endStr}`;
    }

    /**********************************************************************************************
     *                              RENDER METRICS
     **********************************************************************************************/
    function renderMetrics() {
      if (!todayData.length) {
        minPriceEl.innerText = '-';
        maxPriceEl.innerText = '-';
        avgPriceEl.innerText = '-';
        return;
      }
      let minP = Infinity, maxP = -Infinity, sum=0;
      todayData.forEach(d => {
        if (d.value_inc_vat < minP) minP = d.value_inc_vat;
        if (d.value_inc_vat > maxP) maxP = d.value_inc_vat;
        sum += d.value_inc_vat;
      });
      const avgP = sum / todayData.length;
      minPriceEl.innerText = `${minP.toFixed(2)} p/kWh`;
      maxPriceEl.innerText = `${maxP.toFixed(2)} p/kWh`;
      avgPriceEl.innerText = `${avgP.toFixed(2)} p/kWh`;
    }

    /**********************************************************************************************
     *                         PRICE TABLE (HALF-HOURLY)
     **********************************************************************************************/
    function renderPriceTable() {
      priceTableBodyEl.innerHTML = '';
      const now = new Date();
      const future = todayData.filter(d => new Date(d.valid_to) > now);
      if (!future.length) {
        const row = document.createElement('tr');
        const cell= document.createElement('td');
        cell.colSpan=3;
        cell.innerText='No more intervals today.';
        row.appendChild(cell);
        priceTableBodyEl.appendChild(row);
        return;
      }
      future.forEach(item => {
        const row = document.createElement('tr');
        const fromStr = new Date(item.valid_from)
          .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const toStr   = new Date(item.valid_to)
          .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const p = item.value_inc_vat;

        // color-coded row
        if (p < 15) row.classList.add('price-good');
        else if (p < 25) row.classList.add('price-ok');
        else row.classList.add('price-bad');

        const fromTd  = document.createElement('td');
        fromTd.innerText = fromStr;
        const toTd    = document.createElement('td');
        toTd.innerText   = toStr;
        const priceTd = document.createElement('td');
        priceTd.innerText= p.toFixed(2);

        row.appendChild(fromTd);
        row.appendChild(toTd);
        row.appendChild(priceTd);
        priceTableBodyEl.appendChild(row);
      });
    }

    /**********************************************************************************************
     *                             TOMORROW PREVIEW
     **********************************************************************************************/
    function renderTomorrow() {
      if (!tomorrowData.length) {
        tomorrowInfoEl.innerText = 'No data for tomorrow yet.';
        return;
      }
      let minP = Infinity, maxP = -Infinity;
      tomorrowData.forEach(d => {
        if (d.value_inc_vat < minP) minP = d.value_inc_vat;
        if (d.value_inc_vat > maxP) maxP = d.value_inc_vat;
      });
      tomorrowInfoEl.innerText=
        `Min: ${minP.toFixed(2)} p/kWh, Max: ${maxP.toFixed(2)} p/kWh`;
    }

    /**********************************************************************************************
     *                    DRAW A LINE CHART WITH GRID LINES
     **********************************************************************************************/
    function renderChart() {
      chartContainerEl.innerHTML = ''; // clear any old

      if (!todayData.length) {
        // If no data, just put a message
        const msg = document.createElement('div');
        msg.style.padding = '20px';
        msg.innerText = 'No data to chart.';
        chartContainerEl.appendChild(msg);
        return;
      }

      // Create a <canvas> inside the container
      const canvas = document.createElement('canvas');
      canvas.width  = chartContainerEl.clientWidth;
      canvas.height = chartContainerEl.clientHeight;
      chartContainerEl.appendChild(canvas);

      const ctx = canvas.getContext('2d');

      // Sort by time
      todayData.sort((a,b) => new Date(a.valid_from) - new Date(b.valid_from));
      const minTime = new Date(todayData[0].valid_from).getTime();
      const maxTime = new Date(todayData[todayData.length - 1].valid_to).getTime();

      let minPrice = Infinity, maxPrice = -Infinity;
      todayData.forEach(d => {
        if (d.value_inc_vat < minPrice) minPrice = d.value_inc_vat;
        if (d.value_inc_vat > maxPrice) maxPrice = d.value_inc_vat;
      });

      // We'll pad the top by ~10% so the line isn't at the very top
      const pricePadding = (maxPrice - minPrice)*0.1;
      const chartMinP = (pricePadding ? minPrice - pricePadding : minPrice);
      const chartMaxP = (pricePadding ? maxPrice + pricePadding : maxPrice);

      const w = canvas.width;
      const h = canvas.height;

      // We'll draw faint grid lines
      ctx.clearRect(0,0,w,h);

      ctx.fillStyle = '#4A2E60'; 
      ctx.fillRect(0,0,w,h);

      ctx.strokeStyle = 'rgba(255,255,255,0.2)';
      ctx.lineWidth   = 1;

      // Let's draw horizontal grid lines every (approx) 5 p/kWh
      const step = 5; // or compute a dynamic step
      const start = Math.floor(chartMinP/step)*step;
      const end   = Math.ceil(chartMaxP/step)*step;
      for(let val=start; val<=end; val+=step) {
        const yNorm = (val - chartMinP)/(chartMaxP-chartMinP || 1);
        const yPos  = h - (yNorm*h);
        ctx.beginPath();
        ctx.moveTo(0, yPos);
        ctx.lineTo(w, yPos);
        ctx.stroke();

        // label on left
        ctx.fillStyle = '#FFFFFF';
        ctx.font = '12px Roboto';
        ctx.fillText(val+'p', 5, yPos-3);
      }

      // We'll also draw vertical lines for each half-hour from minTime to maxTime
      // The difference in 30-min increments
      const halfHour=1800000; 
      ctx.textAlign = 'center';
      for(let t=minTime; t<=maxTime; t+= halfHour) {
        const xNorm = (t - minTime)/(maxTime - minTime || 1);
        const xPos  = xNorm * w;
        ctx.beginPath();
        ctx.moveTo(xPos,0);
        ctx.lineTo(xPos,h);
        ctx.stroke();

        // time label
        const timeStr = new Date(t)
          .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        ctx.fillStyle = '#FFFFFF';
        ctx.fillText(timeStr, xPos, h-5);
      }

      // Now we draw the line
      ctx.strokeStyle = '#FF00E5';
      ctx.lineWidth   = 2;
      ctx.beginPath();
      todayData.forEach((item, i) => {
        const t = new Date(item.valid_from).getTime();
        const xNorm = (t - minTime)/(maxTime - minTime || 1);
        const x = xNorm*w;
        const priceNorm = (item.value_inc_vat - chartMinP)/(chartMaxP-chartMinP || 1);
        const y = h - priceNorm*h;
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }

    /**********************************************************************************************
     *                       FETCH & DISPLAY UK ENERGY MIX
     **********************************************************************************************/
    async function fetchEnergyMix() {
      try {
        const resp = await fetch(GENERATION_MIX_API);
        if (!resp.ok) throw new Error(`Energy Mix fetch error: ${resp.status}`);
        const data = await resp.json();
        return data;
      } catch (err) {
        throw err;
      }
    }

    function renderEnergyMix(mixData) {
      // mixData is expected in shape: data.generationmix = [ { fuel:'biomass', perc:...}, ... ]
      if (!mixData || !mixData.data || !mixData.data.generationmix) {
        energyMixContainerEl.innerHTML = 'No mix data.';
        return;
      }
      const mixArr = mixData.data.generationmix;

      // Sort by highest to lowest, just for clarity
      mixArr.sort((a,b) => b.perc - a.perc);

      // Render
      energyMixContainerEl.innerHTML = '';
      const grid = document.createElement('div');
      grid.className = 'mix-grid';
      energyMixContainerEl.appendChild(grid);

      mixArr.forEach(item => {
        const wrapper = document.createElement('div');
        wrapper.className = 'mix-item';

        const title = document.createElement('h3');
        title.innerText = item.fuel;
        wrapper.appendChild(title);

        const barContainer = document.createElement('div');
        barContainer.className = 'mix-bar-container';

        const bar = document.createElement('div');
        bar.className = 'mix-bar';
        bar.style.width = item.perc + '%';

        barContainer.appendChild(bar);
        wrapper.appendChild(barContainer);

        const percTxt = document.createElement('div');
        percTxt.className = 'mix-perc';
        percTxt.innerText= item.perc.toFixed(1) + '%';
        wrapper.appendChild(percTxt);

        grid.appendChild(wrapper);
      });
    }

    /**********************************************************************************************
     *                             DEBUG UTILS
     **********************************************************************************************/
    function showDebug(msg) {
      debugLogEl.style.display = 'block';
      debugLogEl.textContent = (typeof msg==='object') ? JSON.stringify(msg) : String(msg);
      console.error(msg);
    }
    function hideDebug() {
      debugLogEl.style.display = 'none';
      debugLogEl.textContent = '';
    }

    /**********************************************************************************************
     *                           MAIN WORKFLOW
     **********************************************************************************************/
    async function fetchAndRenderAll() {
      showDebug(`Fetching Agile data for region: ${regionCode}, and National Grid mix...`);
      try {
        // 1) Fetch Octopus data
        const agileData = await fetchAgileData();
        hideDebug();
        if (!agileData || !agileData.results) {
          throw new Error('No Agile data returned.');
        }
        splitTodayAndTomorrow(agileData.results);
        renderCurrentPrice();
        renderMetrics();
        renderPriceTable();
        renderTomorrow();
        renderChart();

        // 2) Fetch energy mix
        try {
          const mix = await fetchEnergyMix();
          renderEnergyMix(mix);
        } catch (mixErr) {
          showDebug('Could not fetch energy mix data: ' + mixErr);
        }

      } catch (err) {
        showDebug(err);
        priceEl.innerText = 'Error loading price data.';
      }
    }

    function startApp() {
      fetchAndRenderAll();
      setInterval(fetchAndRenderAll, 30 * 60 * 1000); // every 30 mins
    }

    // On load
    startApp();
  </script>
</body>
</html>
