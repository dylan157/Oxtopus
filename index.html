<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Octopus Agile - Interactive Display (No Auto-Detect)</title>

  <!-- OPTIONAL: Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap"
    rel="stylesheet"
  />

  <style>
    /* =============================
       BASE / DARK THEME
       ============================= */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      min-height: 100vh;
      background-color: #1E0D35; /* Dark purple */
      color: #FFFFFF;
      font-family: 'Roboto', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      width: 95%;
      max-width: 900px;
      background-color: #2B1240;
      border-radius: 8px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      animation: fadeIn 0.8s ease-in-out;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-4px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* =============================
       HEADER
       ============================= */
    .header {
      text-align: center;
    }
    .header h1 {
      font-size: 1.8rem;
      color: #FF00E5;
      margin-bottom: 8px;
    }
    .header p {
      font-size: 0.9rem;
      color: #CCCCCC;
    }

    .region-selector {
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .region-selector label {
      font-size: 0.9rem;
      color: #FF00E5;
    }
    .region-selector select {
      padding: 5px 10px;
      border-radius: 4px;
      border: 1px solid #999;
      background-color: #3A1D50;
      color: #FFFFFF;
    }
    .region-selector select:focus {
      outline: 1px solid #FF00E5;
    }

    /* =============================
       CURRENT PRICE CARD
       ============================= */
    .current-price {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 16px;
      text-align: center;
    }
    .current-price .price-display {
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: 5px;
    }
    .current-price .timestamp {
      font-size: 0.9rem;
      color: #BBBBBB;
    }

    /* =============================
       METRICS
       ============================= */
    .metrics {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 16px;
    }
    .metrics-title {
      font-size: 1.2rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 10px;
      color: #FF00E5;
    }
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .metric-item {
      background-color: #4A2E60;
      border-radius: 6px;
      padding: 10px;
      text-align: center;
    }
    .metric-item h2 {
      font-size: 1rem;
      color: #FF00E5;
      margin-bottom: 6px;
    }
    .metric-item p {
      font-size: 1rem;
    }

    /* =============================
       CHART SECTION
       ============================= */
    .chart-section {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 16px;
      position: relative; /* for tooltip */
    }
    .chart-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
      color: #FF00E5;
    }
    .chart-container {
      position: relative;
      width: 100%;
      height: 300px; 
    }
    .chart-container canvas {
      width: 100%;
      height: 100%;
      background-color: #4A2E60;
      border-radius: 6px;
      display: block;
    }
    /* Tooltip for data point hover */
    .chart-tooltip {
      position: absolute;
      background-color: #222;
      color: #fff;
      padding: 6px 8px;
      font-size: 0.8rem;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.1s;
      white-space: nowrap;
    }

    /* =============================
       PRICE TABLE
       ============================= */
    .price-table {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 16px;
    }
    .price-table-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
      color: #FF00E5;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    thead {
      background-color: #4A2E60;
    }
    thead th {
      padding: 8px;
      font-size: 0.9rem;
      font-weight: 700;
      color: #FFFFFF;
    }
    tbody tr {
      border-bottom: 1px solid #4A2E60;
    }
    tbody tr:hover {
      background-color: #5B3E70;
    }
    td {
      padding: 8px;
      font-size: 0.9rem;
      text-align: center;
      color: #FFFFFF;
    }
    /* color-coded intervals: <15 => green, <25 => orange, else => red */
    .price-good {
      background-color: rgba(0, 255, 0, 0.2);
    }
    .price-ok {
      background-color: rgba(255, 165, 0, 0.2);
    }
    .price-bad {
      background-color: rgba(255, 0, 0, 0.2);
    }

    /* =============================
       TOMORROW PREVIEW
       ============================= */
    .tomorrow {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 16px;
      text-align: center;
    }
    .tomorrow-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      color: #FF00E5;
    }

    /* =============================
       DEBUG SECTION
       ============================= */
    .debug {
      background-color: rgba(255, 0, 0, 0.1);
      color: #ff8080;
      font-size: 0.8rem;
      padding: 10px;
      border-radius: 6px;
      display: none;
      word-wrap: break-word;
    }

    /* =============================
       RESPONSIVE
       ============================= */
    @media (max-width: 768px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }
      table thead, table tbody {
        font-size: 0.8rem;
      }
    }
    @media (max-width: 480px) {
      .header h1 {
        font-size: 1.4rem;
      }
      .price-display {
        font-size: 1.4rem;
      }
      .metrics-title, .chart-title, .price-table-title, .tomorrow-title {
        font-size: 1.0rem;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- =============================
         HEADER
         ============================= -->
    <div class="header">
      <h1>Octopus Agile - Interactive (No Auto-Detect)</h1>
      <p>No region auto-detection; just pick your region code.</p>
      <div class="region-selector">
        <label for="regionSelect">Region:</label>
        <select id="regionSelect">
          <option value="A">A (Eastern England)</option>
          <option value="B">B (East Midlands)</option>
          <option value="C">C (London)</option>
          <option value="D">D (Merseyside/N. Wales)</option>
          <option value="E">E (West Midlands)</option>
          <option value="F">F (N. Eastern Eng.)</option>
          <option value="G">G (North Western)</option>
          <option value="H">H (Southern Eng.)</option>
          <option value="J">J (South Eastern)</option>
          <option value="K">K (Southern Scotland)</option>
          <option value="L">L (Northern Scotland)</option>
          <option value="M">M (South Wales)</option>
          <option value="N">N (South Western)</option>
          <option value="P">P (Yorkshire)</option>
        </select>
      </div>
    </div>

    <!-- =============================
         CURRENT PRICE
         ============================= -->
    <div class="current-price">
      <div id="priceDisplay" class="price-display">Loading price...</div>
      <div id="timestampDisplay" class="timestamp"></div>
    </div>

    <!-- =============================
         METRICS
         ============================= -->
    <div class="metrics">
      <div class="metrics-title">Today’s Summary</div>
      <div class="metrics-grid">
        <div class="metric-item">
          <h2>Min Price</h2>
          <p id="minPrice">-</p>
        </div>
        <div class="metric-item">
          <h2>Max Price</h2>
          <p id="maxPrice">-</p>
        </div>
        <div class="metric-item">
          <h2>Average</h2>
          <p id="avgPrice">-</p>
        </div>
      </div>
    </div>

    <!-- =============================
         CHART
         ============================= -->
    <div class="chart-section">
      <div class="chart-title">Today’s Price Chart</div>
      <div class="chart-container">
        <canvas id="chartCanvas"></canvas>
        <div id="chartTooltip" class="chart-tooltip"></div>
      </div>
    </div>

    <!-- =============================
         PRICE TABLE
         ============================= -->
    <div class="price-table">
      <div class="price-table-title">Half-Hourly Prices (Today)</div>
      <table>
        <thead>
          <tr>
            <th>From</th>
            <th>To</th>
            <th>Price (p/kWh)</th>
          </tr>
        </thead>
        <tbody id="priceTableBody"><!-- Filled by JS --></tbody>
      </table>
    </div>

    <!-- =============================
         TOMORROW PREVIEW
         ============================= -->
    <div class="tomorrow">
      <div class="tomorrow-title">Tomorrow’s Preview</div>
      <div id="tomorrowInfo">Checking tomorrow’s data...</div>
    </div>

    <!-- =============================
         DEBUG LOG
         ============================= -->
    <div id="debugLog" class="debug"></div>
  </div>

  <script>
    /************************************************************************
     *                   GLOBAL VARIABLES & REFERENCES                       *
     ************************************************************************/
    const API_BASE = 'https://api.octopus.energy/v1/products/AGILE-18-02-21';
    let regionCode = 'A'; // default
    let todayData = [];
    let tomorrowData = [];

    // DOM elements
    const regionSelectEl   = document.getElementById('regionSelect');
    const priceEl          = document.getElementById('priceDisplay');
    const timestampEl      = document.getElementById('timestampDisplay');
    const minPriceEl       = document.getElementById('minPrice');
    const maxPriceEl       = document.getElementById('maxPrice');
    const avgPriceEl       = document.getElementById('avgPrice');
    const priceTableBodyEl = document.getElementById('priceTableBody');
    const tomorrowInfoEl   = document.getElementById('tomorrowInfo');
    const debugLogEl       = document.getElementById('debugLog');

    // Chart
    const chartCanvas      = document.getElementById('chartCanvas');
    const chartCtx         = chartCanvas.getContext('2d');
    const chartTooltipEl   = document.getElementById('chartTooltip');
    let chartPoints        = [];

    /************************************************************************
     *                          EVENT LISTENERS                              *
     ************************************************************************/
    regionSelectEl.addEventListener('change', () => {
      regionCode = regionSelectEl.value;
      fetchAndRenderAll();
    });

    chartCanvas.addEventListener('mousemove', onCanvasHover);
    chartCanvas.addEventListener('touchmove', onCanvasHover);

    window.addEventListener('resize', () => {
      renderChart();
    });

    /************************************************************************
     *                           FETCH DATA                                  *
     ************************************************************************/
    async function fetchAgileData() {
      const url = `${API_BASE}/electricity-tariffs/E-1R-AGILE-18-02-21-${regionCode}/standard-unit-rates/`;
      try {
        const resp = await fetch(url);
        if (!resp.ok) {
          throw new Error(`HTTP Error: ${resp.status}`);
        }
        return resp.json();
      } catch (err) {
        throw err;
      }
    }

    /************************************************************************
     *                     PARSE INTO TODAY & TOMORROW                       *
     ************************************************************************/
    function splitTodayAndTomorrow(results) {
      todayData = [];
      tomorrowData = [];

      const now = new Date();
      const todayStr = formatDateYYYYMMDD(now);

      const tomorrowDate = new Date(now);
      tomorrowDate.setDate(now.getDate() + 1);
      const tomorrowStr = formatDateYYYYMMDD(tomorrowDate);

      // Sort by valid_from
      results.sort((a, b) => new Date(a.valid_from) - new Date(b.valid_from));

      results.forEach(item => {
        const d = new Date(item.valid_from);
        const dStr = formatDateYYYYMMDD(d);
        if (dStr === todayStr) {
          todayData.push(item);
        } else if (dStr === tomorrowStr) {
          tomorrowData.push(item);
        }
      });
    }

    function formatDateYYYYMMDD(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    /************************************************************************
     *                     RENDER CURRENT PRICE                              *
     ************************************************************************/
    function renderCurrentPrice() {
      const now = new Date();
      const currentPeriod = todayData.find(item => {
        const start = new Date(item.valid_from);
        const end   = new Date(item.valid_to);
        return (start <= now && end > now);
      });
      if (!currentPeriod) {
        priceEl.innerText = 'No current price data.';
        timestampEl.innerText = '';
        return;
      }
      const priceStr = currentPeriod.value_inc_vat.toFixed(2);
      priceEl.innerText = `Current Price: ${priceStr} p/kWh`;

      const fromStr = new Date(currentPeriod.valid_from)
        .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const toStr   = new Date(currentPeriod.valid_to)
        .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      timestampEl.innerText = `Valid: ${fromStr} - ${toStr}`;
    }

    /************************************************************************
     *                        RENDER METRICS                                 *
     ************************************************************************/
    function renderMetrics() {
      if (!todayData.length) {
        minPriceEl.innerText = '-';
        maxPriceEl.innerText = '-';
        avgPriceEl.innerText = '-';
        return;
      }
      let minP = Infinity, maxP = -Infinity, sum = 0;
      for (const item of todayData) {
        const p = item.value_inc_vat;
        if (p < minP) minP = p;
        if (p > maxP) maxP = p;
        sum += p;
      }
      const avgP = sum / todayData.length;
      minPriceEl.innerText = `${minP.toFixed(2)} p/kWh`;
      maxPriceEl.innerText = `${maxP.toFixed(2)} p/kWh`;
      avgPriceEl.innerText = `${avgP.toFixed(2)} p/kWh`;
    }

    /************************************************************************
     *                        RENDER CHART                                   *
     ************************************************************************/
    function renderChart() {
      const cWidth  = chartCanvas.clientWidth;
      const cHeight = chartCanvas.clientHeight;
      chartCanvas.width  = cWidth  * window.devicePixelRatio;
      chartCanvas.height = cHeight * window.devicePixelRatio;
      chartCtx.scale(window.devicePixelRatio, window.devicePixelRatio);

      chartPoints = [];

      // No data?
      if (!todayData.length) {
        chartCtx.clearRect(0, 0, cWidth, cHeight);
        chartCtx.fillStyle = '#fff';
        chartCtx.fillText('No data.', 10, 30);
        return;
      }
      // sort
      todayData.sort((a,b) => new Date(a.valid_from) - new Date(b.valid_from));
      // compute min/max time & price
      const minTime = new Date(todayData[0].valid_from).getTime();
      const maxTime = new Date(todayData[todayData.length - 1].valid_to).getTime();
      let minPrice = Infinity, maxPrice = -Infinity;
      todayData.forEach(d => {
        if (d.value_inc_vat < minPrice) minPrice = d.value_inc_vat;
        if (d.value_inc_vat > maxPrice) maxPrice = d.value_inc_vat;
      });
      const timeRange  = maxTime - minTime || 1;
      const priceRange = maxPrice - minPrice || 1;

      // Clear
      chartCtx.clearRect(0, 0, cWidth, cHeight);

      // Plot
      chartCtx.strokeStyle = '#FF00E5';
      chartCtx.lineWidth   = 2;
      chartCtx.beginPath();

      todayData.forEach((item, i) => {
        const fromT = new Date(item.valid_from).getTime();
        const xNorm = (fromT - minTime) / timeRange;
        const x = xNorm * cWidth;
        const yNorm = (item.value_inc_vat - minPrice) / priceRange;
        const y = cHeight - yNorm * cHeight;

        chartPoints.push({ x, y, price: item.value_inc_vat });

        if (i === 0) {
          chartCtx.moveTo(x, y);
        } else {
          chartCtx.lineTo(x, y);
        }
      });
      chartCtx.stroke();

      // Circle markers
      chartCtx.fillStyle = '#FF00E5';
      chartPoints.forEach(pt => {
        chartCtx.beginPath();
        chartCtx.arc(pt.x, pt.y, 3, 0, 2*Math.PI);
        chartCtx.fill();
      });

      // Label min & max
      chartCtx.fillStyle = '#fff';
      chartCtx.fillText(`Min: ${minPrice.toFixed(2)}`, 10, cHeight - 10);
      chartCtx.fillText(`Max: ${maxPrice.toFixed(2)}`, 10, 20);
    }

    function onCanvasHover(e) {
      const rect = chartCanvas.getBoundingClientRect();
      let clientX, clientY;
      if (e.touches && e.touches.length) {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
      } else {
        clientX = e.clientX;
        clientY = e.clientY;
      }
      const x = clientX - rect.left;
      const y = clientY - rect.top;

      let closest = null;
      let minDist = Infinity;
      chartPoints.forEach(pt => {
        const dx = pt.x - x;
        const dy = pt.y - y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < minDist) {
          minDist = dist;
          closest = pt;
        }
      });

      // if near enough
      if (closest && minDist < 25) {
        chartTooltipEl.innerText = `${closest.price.toFixed(2)} p/kWh`;
        chartTooltipEl.style.left = (rect.left + closest.x + 10) + 'px';
        chartTooltipEl.style.top  = (rect.top  + closest.y - 20) + 'px';
        chartTooltipEl.style.opacity = 1;
      } else {
        chartTooltipEl.style.opacity = 0;
      }
    }

    /************************************************************************
     *                        RENDER PRICE TABLE                             *
     ************************************************************************/
    function renderPriceTable() {
      priceTableBodyEl.innerHTML = '';
      const now = new Date();
      const future = todayData.filter(d => {
        const end = new Date(d.valid_to);
        return end > now;
      });
      if (!future.length) {
        const row = document.createElement('tr');
        const cell= document.createElement('td');
        cell.colSpan = 3;
        cell.innerText = 'No more intervals today.';
        row.appendChild(cell);
        priceTableBodyEl.appendChild(row);
        return;
      }
      future.forEach(item => {
        const row = document.createElement('tr');
        const fromStr = new Date(item.valid_from)
          .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const toStr   = new Date(item.valid_to)
          .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const p = item.value_inc_vat;

        // color-coded row
        if (p < 15) {
          row.classList.add('price-good');
        } else if (p < 25) {
          row.classList.add('price-ok');
        } else {
          row.classList.add('price-bad');
        }

        const fromTd  = document.createElement('td');
        fromTd.innerText = fromStr;
        const toTd    = document.createElement('td');
        toTd.innerText   = toStr;
        const priceTd = document.createElement('td');
        priceTd.innerText= p.toFixed(2);

        row.appendChild(fromTd);
        row.appendChild(toTd);
        row.appendChild(priceTd);
        priceTableBodyEl.appendChild(row);
      });
    }

    /************************************************************************
     *                        TOMORROW PREVIEW                               *
     ************************************************************************/
    function renderTomorrow() {
      if (!tomorrowData.length) {
        tomorrowInfoEl.innerText = 'No data for tomorrow yet.';
        return;
      }
      let minP = Infinity, maxP = -Infinity;
      for (const item of tomorrowData) {
        const p = item.value_inc_vat;
        if (p < minP) minP = p;
        if (p > maxP) maxP = p;
      }
      tomorrowInfoEl.innerText = 
        `Min: ${minP.toFixed(2)} p/kWh, Max: ${maxP.toFixed(2)} p/kWh`;
    }

    /************************************************************************
     *                        DEBUG LOG                                      *
     ************************************************************************/
    function showDebug(msg) {
      debugLogEl.style.display = 'block';
      debugLogEl.textContent = (typeof msg === 'object') ? JSON.stringify(msg) : String(msg);
      console.error(msg);
    }
    function hideDebug() {
      debugLogEl.style.display = 'none';
      debugLogEl.textContent = '';
    }

    /************************************************************************
     *                           MAIN LOGIC                                  *
     ************************************************************************/
    async function fetchAndRenderAll() {
      showDebug(`Fetching data for region: ${regionCode}...`);
      try {
        const data = await fetchAgileData();
        hideDebug();
        if (!data || !data.results) {
          throw new Error('No results from API');
        }
        splitTodayAndTomorrow(data.results);

        renderCurrentPrice();
        renderMetrics();
        renderChart();
        renderPriceTable();
        renderTomorrow();
      } catch (err) {
        showDebug(err);
        priceEl.innerText = 'Error fetching data.';
      }
    }

    // Run once, then every 30 minutes
    fetchAndRenderAll();
    setInterval(fetchAndRenderAll, 30 * 60 * 1000);
  </script>
</body>
</html>
