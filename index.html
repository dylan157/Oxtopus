<!DOCTYPE html>
<html lang="en">
<!-- 
  ---------------------------------------------------------------------------------------------
  |                                                                                           |
  |     OCTOPUS AGILE PRICE DISPLAY - LARGE SINGLE-PAGE WITH REGION DROPDOWN & RESPONSIVE     |
  |     CHART FIXES FOR MOBILE                                                                |
  |                                                                                           |
  ---------------------------------------------------------------------------------------------
-->
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Octopus Agile Price Display – Region & Responsive Chart</title>

  <!-- OPTIONAL FONT: ROBOTO -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap"
    rel="stylesheet"
  />

  <style>
    /* 
      ================
      BASE / RESET
      ================
    */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Roboto', sans-serif;
      background-color: #1E0D35; /* Dark purple background */
      color: #FFFFFF; /* White text for contrast */
    }

    /* 
      =========================
      MAIN CONTAINER & FADE-IN
      =========================
    */
    .main-container {
      width: 95%;
      max-width: 900px;
      background-color: #2B1240;
      border-radius: 8px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
      padding: 20px;
      margin: 20px auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
      animation: fadeIn 0.8s ease-in-out;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* 
      ========================
      HEADER SECTION
      ========================
    */
    .header-section {
      text-align: center;
    }
    .header-section h1 {
      color: #FF00E5;
      font-size: 1.8rem;
      margin-bottom: 10px;
      font-weight: 700;
    }
    .header-section p {
      font-size: 0.9rem;
      color: #CCCCCC;
    }

    /* Region Selector */
    .region-selector {
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .region-selector label {
      font-size: 0.9rem;
      color: #FF00E5;
    }
    .region-selector select {
      padding: 5px 10px;
      border-radius: 4px;
      border: 1px solid #999;
      background-color: #3A1D50;
      color: #FFFFFF;
    }
    .region-selector select:focus {
      outline: 1px solid #FF00E5;
    }

    /* 
      ========================
      CURRENT PRICE SECTION
      ========================
    */
    .current-price-section {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 15px;
      text-align: center;
    }
    .price-display {
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .timestamp-display {
      font-size: 0.9rem;
      color: #BBBBBB;
    }

    /* 
      ========================
      METRICS SECTION
      ========================
    */
    .metrics-section {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 15px;
    }
    .metrics-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
      color: #FF00E5;
    }
    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .metric-item {
      background-color: #4A2E60;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
    }
    .metric-item h2 {
      font-size: 1.1rem;
      margin-bottom: 5px;
      color: #FF00E5;
    }
    .metric-item p {
      font-size: 1rem;
      color: #FFFFFF;
    }

    /* 
      ========================
      PRICE TABLE SECTION
      ========================
    */
    .price-table-section {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 15px;
    }
    .price-table-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
      color: #FF00E5;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    thead {
      background-color: #4A2E60;
    }
    thead th {
      padding: 8px;
      font-size: 0.9rem;
      font-weight: 700;
      color: #FFFFFF;
    }
    tbody tr {
      border-bottom: 1px solid #4A2E60;
    }
    tbody tr:hover {
      background-color: #5B3E70;
    }
    td {
      padding: 8px;
      font-size: 0.9rem;
      text-align: center;
      color: #FFFFFF;
    }

    /* 
      ========================
      CHART SECTION
      ========================
    */
    .chart-section {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 15px;
    }
    .chart-section-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
      color: #FF00E5;
    }
    .chart-container {
      position: relative;
      width: 100%;
      /* By default, let's fix height to ~300px on all screens. 
         The canvas will be scaled to container width. */
      height: 300px; 
    }
    .chart-container canvas {
      /* Make the canvas fill the container’s width, maintain a set height */
      width: 100%;
      height: 100%;
      background-color: #4A2E60;
      border-radius: 6px;
      display: block;
    }

    /* 
      ========================
      TOMORROW PREVIEW SECTION
      ========================
    */
    .tomorrow-section {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 15px;
    }
    .tomorrow-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
      color: #FF00E5;
    }
    .tomorrow-content {
      text-align: center;
      color: #FFFFFF;
    }

    /* 
      ========================
      DEBUG SECTION
      ========================
    */
    .debug-section {
      background-color: rgba(255, 0, 0, 0.1);
      color: #ff8080;
      font-size: 0.8rem;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      display: none;
      word-wrap: break-word;
    }

    /* 
      ========================
      RESPONSIVENESS 
      ========================
    */
    @media (max-width: 768px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }
      table thead, table tbody {
        font-size: 0.8rem;
      }
    }
    @media (max-width: 480px) {
      .header-section h1 {
        font-size: 1.4rem;
      }
      .price-display {
        font-size: 1.4rem;
      }
      .metrics-title,
      .price-table-title,
      .chart-section-title,
      .tomorrow-title {
        font-size: 1.0rem;
      }
    }
  </style>
</head>

<body>
  <!-- 
    =======================
    MAIN CONTAINER
    =======================
  -->
  <div class="main-container">
    <!-- 
      =======================
      HEADER SECTION
      =======================
    -->
    <div class="header-section">
      <h1>Octopus Agile Price - Regions & Chart</h1>
      <p>Now with a region selector and responsive chart for mobile!</p>
      <div class="region-selector">
        <label for="regionSelect">Select Region:</label>
        <select id="regionSelect">
          <!-- Some known region codes for Agile (there is no 'I' or 'O' for example). 
               Full list includes: A, B, C, D, E, F, G, H, J, K, L, M, N, P
               We'll list them all here. -->
          <option value="A">A (Eastern England)</option>
          <option value="B">B (East Midlands)</option>
          <option value="C">C (London)</option>
          <option value="D">D (Merseyside and North Wales)</option>
          <option value="E">E (West Midlands)</option>
          <option value="F">F (North Eastern England)</option>
          <option value="G">G (North Western)</option>
          <option value="H">H (Southern England)</option>
          <option value="J">J (South Eastern)</option>
          <option value="K">K (Southern Scotland)</option>
          <option value="L">L (Northern Scotland)</option>
          <option value="M">M (South Wales)</option>
          <option value="N">N (South Western)</option>
          <option value="P">P (Yorkshire)</option>
        </select>
      </div>
    </div>

    <!-- 
      =======================
      CURRENT PRICE SECTION
      =======================
    -->
    <div class="current-price-section">
      <div id="price" class="price-display">Loading current price...</div>
      <div id="timestamp" class="timestamp-display"></div>
    </div>

    <!-- 
      =======================
      METRICS SECTION
      =======================
    -->
    <div class="metrics-section">
      <div class="metrics-title">Today's Summary</div>
      <div class="metrics-grid">
        <div class="metric-item">
          <h2>Min Price</h2>
          <p id="minPriceValue">-</p>
        </div>
        <div class="metric-item">
          <h2>Max Price</h2>
          <p id="maxPriceValue">-</p>
        </div>
        <div class="metric-item">
          <h2>Average</h2>
          <p id="avgPriceValue">-</p>
        </div>
      </div>
    </div>

    <!-- 
      =======================
      PRICE TABLE SECTION
      =======================
    -->
    <div class="price-table-section">
      <div class="price-table-title">Half-Hourly Price Data (Today)</div>
      <table>
        <thead>
          <tr>
            <th>Time From</th>
            <th>Time To</th>
            <th>Price (p/kWh)</th>
          </tr>
        </thead>
        <tbody id="priceTableBody">
          <!-- Populated by JS -->
        </tbody>
      </table>
    </div>

    <!-- 
      =======================
      CHART SECTION
      =======================
    -->
    <div class="chart-section">
      <div class="chart-section-title">Today's Price Chart</div>
      <div class="chart-container">
        <canvas id="priceChart"></canvas>
      </div>
    </div>

    <!-- 
      =======================
      TOMORROW PREVIEW
      =======================
    -->
    <div class="tomorrow-section">
      <div class="tomorrow-title">Tomorrow's Preview</div>
      <div class="tomorrow-content" id="tomorrowContent">
        Checking tomorrow's data...
      </div>
    </div>

    <!-- 
      =======================
      DEBUG SECTION
      =======================
    -->
    <div id="debug" class="debug-section"></div>

  </div> <!-- END .main-container -->

  <script>
    /************************************************************************************************
     *             LARGE SINGLE-PAGE JAVASCRIPT                                                     *
     *             Region Dropdown + Responsive Chart Fix                                           *
     ************************************************************************************************/

    // ----------------------------------------------------------------------------------------------
    // 0. GLOBAL VARIABLES & ELEMENT REFERENCES
    // ----------------------------------------------------------------------------------------------
    const OCTOPUS_API_BASE = 'https://api.octopus.energy/v1/products/AGILE-18-02-21';
    let currentRegion = 'A'; // Default region
    let todayData = [];
    let tomorrowData = [];

    // DOM elements
    const regionSelectEl    = document.getElementById('regionSelect');
    const priceEl           = document.getElementById('price');
    const timestampEl       = document.getElementById('timestamp');
    const priceTableBodyEl  = document.getElementById('priceTableBody');
    const minPriceValueEl   = document.getElementById('minPriceValue');
    const maxPriceValueEl   = document.getElementById('maxPriceValue');
    const avgPriceValueEl   = document.getElementById('avgPriceValue');
    const tomorrowContentEl = document.getElementById('tomorrowContent');
    const debugEl           = document.getElementById('debug');

    // Chart canvas
    const priceChartCanvas = document.getElementById('priceChart');
    const priceChartCtx    = priceChartCanvas.getContext('2d');

    // ----------------------------------------------------------------------------------------------
    // 1. EVENT LISTENER FOR REGION SELECT
    // ----------------------------------------------------------------------------------------------
    regionSelectEl.addEventListener('change', () => {
      currentRegion = regionSelectEl.value;
      main(); // Re-run the main process with new region
    });

    // ----------------------------------------------------------------------------------------------
    // 2. FETCH DATA
    // ----------------------------------------------------------------------------------------------
    async function fetchAgileData(region) {
      const url = `${OCTOPUS_API_BASE}/electricity-tariffs/E-1R-AGILE-18-02-21-${region}/standard-unit-rates/`;
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        return data;
      } catch (error) {
        throw error;
      }
    }

    // ----------------------------------------------------------------------------------------------
    // 3. ORGANIZE DATA BY TODAY / TOMORROW
    // ----------------------------------------------------------------------------------------------
    function separateTodayAndTomorrowData(results) {
      todayData = [];
      tomorrowData = [];
      const now = new Date();
      const todayDateString = formatDateYYYYMMDD(now);

      const tomorrowDate = new Date(now);
      tomorrowDate.setDate(now.getDate() + 1);
      const tomorrowDateString = formatDateYYYYMMDD(tomorrowDate);

      results.sort((a, b) => new Date(a.valid_from) - new Date(b.valid_from));

      results.forEach(item => {
        const itemDate = new Date(item.valid_from);
        const itemDateString = formatDateYYYYMMDD(itemDate);
        if (itemDateString === todayDateString) {
          todayData.push(item);
        } else if (itemDateString === tomorrowDateString) {
          tomorrowData.push(item);
        }
      });
    }

    function formatDateYYYYMMDD(d) {
      const year  = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day   = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // ----------------------------------------------------------------------------------------------
    // 4. FIND CURRENT PERIOD
    // ----------------------------------------------------------------------------------------------
    function findCurrentPeriod(dataArray) {
      const now = new Date();
      return dataArray.find(period => {
        const start = new Date(period.valid_from);
        const end   = new Date(period.valid_to);
        return start <= now && end > now;
      }) || null;
    }

    // ----------------------------------------------------------------------------------------------
    // 5. METRICS: MIN, MAX, AVERAGE
    // ----------------------------------------------------------------------------------------------
    function calculateDailyMetrics(dataArray) {
      if (!dataArray || dataArray.length === 0) {
        return { min: null, max: null, avg: null };
      }
      let minPrice = Infinity;
      let maxPrice = -Infinity;
      let sum = 0;
      dataArray.forEach(interval => {
        const price = interval.value_inc_vat;
        if (price < minPrice) minPrice = price;
        if (price > maxPrice) maxPrice = price;
        sum += price;
      });
      const avg = sum / dataArray.length;
      return { min: minPrice, max: maxPrice, avg };
    }

    // ----------------------------------------------------------------------------------------------
    // 6. RENDER: CURRENT PRICE
    // ----------------------------------------------------------------------------------------------
    function renderCurrentPrice() {
      const currentPeriod = findCurrentPeriod(todayData);
      if (currentPeriod) {
        const priceStr = currentPeriod.value_inc_vat.toFixed(2);
        priceEl.innerText = `Current Price: ${priceStr} p/kWh`;
        const fromTime = new Date(currentPeriod.valid_from).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const toTime   = new Date(currentPeriod.valid_to).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        timestampEl.innerText = `Valid from: ${fromTime} to ${toTime}`;
      } else {
        priceEl.innerText = 'No current price data available.';
        timestampEl.innerText = '';
      }
    }

    // ----------------------------------------------------------------------------------------------
    // 7. RENDER: METRICS
    // ----------------------------------------------------------------------------------------------
    function renderMetrics() {
      const { min, max, avg } = calculateDailyMetrics(todayData);
      if (min === null) {
        minPriceValueEl.innerText = '—';
        maxPriceValueEl.innerText = '—';
        avgPriceValueEl.innerText = '—';
        return;
      }
      minPriceValueEl.innerText = `${min.toFixed(2)} p/kWh`;
      maxPriceValueEl.innerText = `${max.toFixed(2)} p/kWh`;
      avgPriceValueEl.innerText = `${avg.toFixed(2)} p/kWh`;
    }

    // ----------------------------------------------------------------------------------------------
    // 8. RENDER: PRICE TABLE (for the rest of today)
    // ----------------------------------------------------------------------------------------------
    function renderPriceTable() {
      priceTableBodyEl.innerHTML = '';
      const now = new Date();
      const futureIntervals = todayData.filter(interval => {
        const end = new Date(interval.valid_to);
        return end > now;
      });
      if (futureIntervals.length === 0) {
        const noDataRow = document.createElement('tr');
        const noDataCell = document.createElement('td');
        noDataCell.colSpan = 3;
        noDataCell.innerText = 'No more intervals for the rest of today.';
        noDataRow.appendChild(noDataCell);
        priceTableBodyEl.appendChild(noDataRow);
        return;
      }
      futureIntervals.forEach(interval => {
        const row = document.createElement('tr');
        const fromCell = document.createElement('td');
        const toCell   = document.createElement('td');
        const priceCell= document.createElement('td');

        const fromTime = new Date(interval.valid_from).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        fromCell.innerText = fromTime;

        const toTime = new Date(interval.valid_to).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        toCell.innerText = toTime;

        priceCell.innerText = interval.value_inc_vat.toFixed(2);

        row.appendChild(fromCell);
        row.appendChild(toCell);
        row.appendChild(priceCell);
        priceTableBodyEl.appendChild(row);
      });
    }

    // ----------------------------------------------------------------------------------------------
    // 9. RENDER: CHART (RESPONSIVE)
    // ----------------------------------------------------------------------------------------------
    function renderChart() {
      // We'll measure the canvas's current "client" size and set its internal drawing scale
      const canvasWidth  = priceChartCanvas.clientWidth;
      const canvasHeight = priceChartCanvas.clientHeight;

      // Adjust the internal resolution to match the displayed size
      // (so it won't be blurry on high DPI screens)
      priceChartCanvas.width  = canvasWidth * window.devicePixelRatio;
      priceChartCanvas.height = canvasHeight * window.devicePixelRatio;
      // Now, update the 2D context scale
      priceChartCtx.scale(window.devicePixelRatio, window.devicePixelRatio);

      if (!todayData || todayData.length === 0) {
        priceChartCtx.clearRect(0, 0, canvasWidth, canvasHeight);
        priceChartCtx.fillStyle = '#FFFFFF';
        priceChartCtx.fillText('No data for chart', 10, 50);
        return;
      }

      // Sort by valid_from
      todayData.sort((a, b) => new Date(a.valid_from) - new Date(b.valid_from));
      const minTime = new Date(todayData[0].valid_from).getTime();
      const maxTime = new Date(todayData[todayData.length - 1].valid_to).getTime();

      const chartPoints = todayData.map(interval => {
        const startTime = new Date(interval.valid_from).getTime();
        // Normalized X from 0..1
        const xNorm = (startTime - minTime) / (maxTime - minTime || 1);
        // We'll store the price as y value
        return { xNorm, y: interval.value_inc_vat };
      });

      let minPrice = Infinity, maxPrice = -Infinity;
      chartPoints.forEach(pt => {
        if (pt.y < minPrice) minPrice = pt.y;
        if (pt.y > maxPrice) maxPrice = pt.y;
      });
      const priceRange = maxPrice - minPrice || 1;

      // Clear
      priceChartCtx.clearRect(0, 0, canvasWidth, canvasHeight);

      // Draw baseline
      priceChartCtx.strokeStyle = '#CCCCCC';
      priceChartCtx.lineWidth = 1;
      priceChartCtx.beginPath();
      priceChartCtx.moveTo(0, canvasHeight - 1);
      priceChartCtx.lineTo(canvasWidth, canvasHeight - 1);
      priceChartCtx.stroke();

      // Plot line
      priceChartCtx.strokeStyle = '#FF00E5';
      priceChartCtx.lineWidth = 2;
      priceChartCtx.beginPath();
      chartPoints.forEach((pt, i) => {
        const x = pt.xNorm * canvasWidth;
        // Flip the Y scale
        const yNorm = (pt.y - minPrice) / priceRange;
        const y = canvasHeight - (yNorm * canvasHeight);
        if (i === 0) {
          priceChartCtx.moveTo(x, y);
        } else {
          priceChartCtx.lineTo(x, y);
        }
      });
      priceChartCtx.stroke();

      // Circle markers
      priceChartCtx.fillStyle = '#FF00E5';
      chartPoints.forEach(pt => {
        const x = pt.xNorm * canvasWidth;
        const yNorm = (pt.y - minPrice) / priceRange;
        const y = canvasHeight - (yNorm * canvasHeight);
        priceChartCtx.beginPath();
        priceChartCtx.arc(x, y, 3, 0, 2*Math.PI);
        priceChartCtx.fill();
      });

      // Labels for min & max
      priceChartCtx.fillStyle = '#FFFFFF';
      priceChartCtx.fillText(`${minPrice.toFixed(2)} p`, 10, canvasHeight - 10);
      priceChartCtx.fillText(`${maxPrice.toFixed(2)} p`, 10, 20);
    }

    // ----------------------------------------------------------------------------------------------
    // 10. RENDER: TOMORROW PREVIEW
    // ----------------------------------------------------------------------------------------------
    function renderTomorrowPreview() {
      if (!tomorrowData || tomorrowData.length === 0) {
        tomorrowContentEl.innerText = 'No data available for tomorrow yet.';
        return;
      }
      const { min, max } = calculateDailyMetrics(tomorrowData);
      if (min === null) {
        tomorrowContentEl.innerText = 'No data available for tomorrow yet.';
        return;
      }
      tomorrowContentEl.innerText = `Min: ${min.toFixed(2)} p/kWh, Max: ${max.toFixed(2)} p/kWh (tomorrow)`;
    }

    // ----------------------------------------------------------------------------------------------
    // 11. DEBUG MESSAGES
    // ----------------------------------------------------------------------------------------------
    function showDebug(msg) {
      debugEl.style.display = 'block';
      if (typeof msg === 'object' && msg !== null) {
        debugEl.textContent = `Error: ${msg.message || JSON.stringify(msg)}`;
      } else {
        debugEl.textContent = String(msg);
      }
      console.error(msg);
    }
    function hideDebug() {
      debugEl.style.display = 'none';
      debugEl.textContent = '';
    }

    // ----------------------------------------------------------------------------------------------
    // 12. MAIN WORKFLOW
    // ----------------------------------------------------------------------------------------------
    async function main() {
      showDebug(`Fetching data for region: ${currentRegion}...`);
      try {
        const data = await fetchAgileData(currentRegion);
        if (!data || !data.results) {
          throw new Error('No data returned by API.');
        }
        hideDebug();

        separateTodayAndTomorrowData(data.results);

        renderCurrentPrice();
        renderMetrics();
        renderPriceTable();
        renderChart();
        renderTomorrowPreview();

        hideDebug();
      } catch (error) {
        showDebug(error);
        priceEl.innerText = 'Error fetching price data.';
        timestampEl.innerText = '';
      }
    }

    // Run main once, then every 30 minutes
    main();
    setInterval(main, 30 * 60 * 1000);

    // Optionally, re-render chart on window resize (to keep it fully responsive)
    window.addEventListener('resize', () => {
      renderChart();
    });
  </script>
</body>
</html>
