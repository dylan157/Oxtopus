<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Octopus Agile - Brand New Interactive Display</title>

  <!-- Optional Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap"
    rel="stylesheet"
  />

  <style>
    /* =============================
       BASE STYLES / DARK THEME
       ============================= */
    * {
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
    }
    body {
      min-height: 100vh;
      background-color: #1E0D35; /* Dark purple */
      color: #FFFFFF;
      font-family: 'Roboto', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      width: 95%;
      max-width: 900px;
      background-color: #2B1240;
      border-radius: 8px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      animation: fadeIn 0.8s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-4px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* =============================
       HEADER SECTION
       ============================= */
    .header {
      text-align: center;
    }
    .header h1 {
      font-size: 1.8rem;
      color: #FF00E5; /* Octopus pink/magenta */
      margin-bottom: 8px;
    }
    .header p {
      font-size: 0.9rem;
      color: #CCCCCC;
    }

    .region-selector {
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .region-selector label {
      font-size: 0.9rem;
      color: #FF00E5;
    }
    .region-selector select {
      padding: 5px 10px;
      border-radius: 4px;
      border: 1px solid #999;
      background-color: #3A1D50;
      color: #FFFFFF;
    }
    .region-selector button {
      padding: 5px 10px;
      border-radius: 4px;
      border: 1px solid #999;
      background-color: #FF00E5;
      color: #FFFFFF;
      cursor: pointer;
    }
    .region-selector button:hover {
      opacity: 0.9;
    }

    /* =============================
       CURRENT PRICE CARD
       ============================= */
    .current-price {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 16px;
      text-align: center;
    }
    .current-price .price-display {
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: 5px;
    }
    .current-price .timestamp {
      font-size: 0.9rem;
      color: #BBBBBB;
    }

    /* =============================
       METRICS SECTION
       ============================= */
    .metrics {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 16px;
    }
    .metrics-title {
      font-size: 1.2rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 10px;
      color: #FF00E5;
    }
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .metric-item {
      background-color: #4A2E60;
      border-radius: 6px;
      padding: 10px;
      text-align: center;
    }
    .metric-item h2 {
      font-size: 1rem;
      color: #FF00E5;
      margin-bottom: 6px;
    }
    .metric-item p {
      font-size: 1rem;
    }

    /* =============================
       CHART SECTION
       ============================= */
    .chart-section {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 16px;
      position: relative; /* For tooltip positioning */
    }
    .chart-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
      color: #FF00E5;
    }
    .chart-container {
      position: relative;
      width: 100%;
      height: 300px; /* fixed height, but auto width */
    }
    .chart-container canvas {
      width: 100%;
      height: 100%;
      background-color: #4A2E60;
      border-radius: 6px;
      display: block;
    }

    /* Tooltip for the chart on hover */
    .chart-tooltip {
      position: absolute;
      background-color: #222;
      color: #fff;
      padding: 6px 8px;
      font-size: 0.8rem;
      border-radius: 4px;
      pointer-events: none; /* don't block mouse */
      opacity: 0;
      transition: opacity 0.1s ease-in-out;
      white-space: nowrap;
    }

    /* =============================
       PRICE TABLE SECTION
       ============================= */
    .price-table {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 16px;
    }
    .price-table-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
      color: #FF00E5;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    thead {
      background-color: #4A2E60;
    }
    thead th {
      padding: 8px;
      font-size: 0.9rem;
      font-weight: 700;
      color: #FFFFFF;
    }
    tbody tr {
      border-bottom: 1px solid #4A2E60;
    }
    tbody tr:hover {
      background-color: #5B3E70;
    }
    td {
      padding: 8px;
      font-size: 0.9rem;
      text-align: center;
      color: #FFFFFF;
    }
    /* Color-coded intervals: <15 => green, <25 => orange, otherwise => red. */
    .price-good {
      background-color: rgba(0, 255, 0, 0.2);
    }
    .price-ok {
      background-color: rgba(255, 165, 0, 0.2);
    }
    .price-bad {
      background-color: rgba(255, 0, 0, 0.2);
    }

    /* =============================
       TOMORROW PREVIEW
       ============================= */
    .tomorrow {
      background-color: #3A1D50;
      border-radius: 6px;
      padding: 16px;
      text-align: center;
    }
    .tomorrow-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      color: #FF00E5;
    }

    /* =============================
       DEBUG SECTION
       ============================= */
    .debug {
      background-color: rgba(255, 0, 0, 0.1);
      color: #ff8080;
      font-size: 0.8rem;
      padding: 10px;
      border-radius: 6px;
      display: none;
      word-wrap: break-word;
    }

    /* =============================
       RESPONSIVE
       ============================= */
    @media (max-width: 768px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }
      table thead, table tbody {
        font-size: 0.8rem;
      }
    }
    @media (max-width: 480px) {
      .header h1 {
        font-size: 1.4rem;
      }
      .price-display {
        font-size: 1.4rem;
      }
      .metrics-title, .chart-title, .price-table-title, .tomorrow-title {
        font-size: 1.0rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- =======================================
         HEADER SECTION
         ======================================= -->
    <div class="header">
      <h1>Octopus Agile - New Interactive Display</h1>
      <p>A fresh start: better region checks for Milton Keynes, no 35p cap, interactive chart.</p>
      <div class="region-selector">
        <label for="regionSelect">Choose Region:</label>
        <select id="regionSelect">
          <option value="A">A (Eastern England)</option>
          <option value="B">B (East Midlands)</option>
          <option value="C">C (London)</option>
          <option value="D">D (Merseyside/N. Wales)</option>
          <option value="E">E (West Midlands)</option>
          <option value="F">F (N. Eastern Eng.)</option>
          <option value="G">G (North Western)</option>
          <option value="H">H (Southern Eng.)</option>
          <option value="J">J (South Eastern)</option>
          <option value="K">K (Southern Scotland)</option>
          <option value="L">L (Northern Scotland)</option>
          <option value="M">M (South Wales)</option>
          <option value="N">N (South Western)</option>
          <option value="P">P (Yorkshire)</option>
        </select>
        <button id="autoDetectBtn">Auto-Detect (Geo)</button>
      </div>
    </div>

    <!-- =======================================
         CURRENT PRICE
         ======================================= -->
    <div class="current-price">
      <div id="priceDisplay" class="price-display">Loading price...</div>
      <div id="timestampDisplay" class="timestamp"></div>
    </div>

    <!-- =======================================
         METRICS
         ======================================= -->
    <div class="metrics">
      <div class="metrics-title">Today’s Summary</div>
      <div class="metrics-grid">
        <div class="metric-item">
          <h2>Min Price</h2>
          <p id="minPrice">-</p>
        </div>
        <div class="metric-item">
          <h2>Max Price</h2>
          <p id="maxPrice">-</p>
        </div>
        <div class="metric-item">
          <h2>Average</h2>
          <p id="avgPrice">-</p>
        </div>
      </div>
    </div>

    <!-- =======================================
         CHART
         ======================================= -->
    <div class="chart-section">
      <div class="chart-title">Today’s Price Chart</div>
      <div class="chart-container">
        <canvas id="chartCanvas"></canvas>
        <!-- Tooltip for data hover -->
        <div id="chartTooltip" class="chart-tooltip"></div>
      </div>
    </div>

    <!-- =======================================
         PRICE TABLE
         ======================================= -->
    <div class="price-table">
      <div class="price-table-title">Half-Hourly Prices (Today)</div>
      <table>
        <thead>
          <tr>
            <th>From</th>
            <th>To</th>
            <th>Price (p/kWh)</th>
          </tr>
        </thead>
        <tbody id="priceTableBody"><!-- JS appends rows --></tbody>
      </table>
    </div>

    <!-- =======================================
         TOMORROW PREVIEW
         ======================================= -->
    <div class="tomorrow">
      <div class="tomorrow-title">Tomorrow’s Preview</div>
      <div id="tomorrowInfo">Checking tomorrow’s data...</div>
    </div>

    <!-- =======================================
         DEBUG
         ======================================= -->
    <div id="debugLog" class="debug"></div>
  </div>

  <script>
    /*******************************************************************************
     *                           GLOBAL VARIABLES                                  *
     ******************************************************************************/
    const API_BASE = 'https://api.octopus.energy/v1/products/AGILE-18-02-21';

    let regionCode = 'A'; // Default region
    let todayData = [];
    let tomorrowData = [];

    // DOM references
    const regionSelectEl     = document.getElementById('regionSelect');
    const autoDetectBtnEl    = document.getElementById('autoDetectBtn');
    const priceEl            = document.getElementById('priceDisplay');
    const timestampEl        = document.getElementById('timestampDisplay');
    const minPriceEl         = document.getElementById('minPrice');
    const maxPriceEl         = document.getElementById('maxPrice');
    const avgPriceEl         = document.getElementById('avgPrice');
    const priceTableBodyEl   = document.getElementById('priceTableBody');
    const tomorrowInfoEl     = document.getElementById('tomorrowInfo');
    const debugLogEl         = document.getElementById('debugLog');

    // Chart references
    const chartCanvas        = document.getElementById('chartCanvas');
    const chartCtx           = chartCanvas.getContext('2d');
    const chartTooltipEl     = document.getElementById('chartTooltip');
    let chartPoints = []; // We'll store scaled x/y for interactive tooltip

    /*******************************************************************************
     *                           EVENT LISTENERS                                   *
     ******************************************************************************/
    regionSelectEl.addEventListener('change', () => {
      regionCode = regionSelectEl.value;
      fetchAndRenderAll();
    });

    autoDetectBtnEl.addEventListener('click', () => {
      if (!navigator.geolocation) {
        showDebug('Geolocation not supported by this browser. Using default region A.');
        regionCode = 'A';
        regionSelectEl.value = 'A';
        fetchAndRenderAll();
        return;
      }
      navigator.geolocation.getCurrentPosition(
        position => {
          const { latitude, longitude } = position.coords;
          regionCode = guessRegion(latitude, longitude);
          regionSelectEl.value = regionCode;
          fetchAndRenderAll();
        },
        error => {
          showDebug('Geolocation failed or denied. Defaulting to region A.');
          regionCode = 'A';
          regionSelectEl.value = 'A';
          fetchAndRenderAll();
        }
      );
    });

    // Chart hover
    chartCanvas.addEventListener('mousemove', onCanvasHover);
    chartCanvas.addEventListener('touchmove', onCanvasHover);

    // Rerender chart on window resize (makes it more responsive)
    window.addEventListener('resize', () => renderChart());

    /*******************************************************************************
     *           APPROXIMATE REGION GUESSING FOR MILTON KEYNES, ETC.               *
     *  (Purely bounding-box approach, not official distribution boundaries)       *
     ******************************************************************************/
    function guessRegion(lat, lon) {
      // We'll define some bounding boxes so Milton Keynes (roughly lat=52.0, lon=-0.76) → region A
      // Real distribution boundaries are more complex. This is purely approximate.
      // If not found, fallback to A.

      // First check if in the general UK bounding box (roughly lat 49..59, lon -8..2):
      if (lat < 49 || lat > 59 || lon < -8 || lon > 2) {
        return 'A';
      }

      // Specifically for Milton Keynes area:
      // MK is around lat ~ 51.8..52.2, lon ~ -0.9..-0.5
      if (lat >= 51.7 && lat <= 52.3 && lon >= -1.0 && lon <= -0.3) {
        // We'll assume region A
        return 'A';
      }

      // Very rough approach for "London" region (region C):
      // Let's say lat ~ 51.2..51.7, lon ~ -0.5..0.2
      if (lat >= 51.2 && lat <= 51.7 && lon >= -0.5 && lon <= 0.2) {
        return 'C';
      }

      // Very rough approach for East Midlands (region B):
      if (lat >= 52.5 && lat <= 53.5 && lon >= -1.5 && lon <= -0.3) {
        return 'B';
      }

      // Otherwise default to A to keep it simple
      return 'A';
    }

    /*******************************************************************************
     *                             FETCH & PROCESS DATA                             *
     ******************************************************************************/
    async function fetchAgileData() {
      const url = `${API_BASE}/electricity-tariffs/E-1R-AGILE-18-02-21-${regionCode}/standard-unit-rates/`;
      try {
        const resp = await fetch(url);
        if (!resp.ok) {
          throw new Error(`HTTP Error: ${resp.status}`);
        }
        const data = await resp.json();
        return data;
      } catch (err) {
        throw err;
      }
    }

    function splitTodayAndTomorrow(results) {
      todayData = [];
      tomorrowData = [];
      const now = new Date();
      const todayStr = formatDateYYYYMMDD(now);

      const tomorrowDate = new Date(now);
      tomorrowDate.setDate(now.getDate() + 1);
      const tomorrowStr = formatDateYYYYMMDD(tomorrowDate);

      // Sort
      results.sort((a, b) => new Date(a.valid_from) - new Date(b.valid_from));
      for (const item of results) {
        const d = new Date(item.valid_from);
        const dStr = formatDateYYYYMMDD(d);
        if (dStr === todayStr) {
          todayData.push(item);
        } else if (dStr === tomorrowStr) {
          tomorrowData.push(item);
        }
      }
    }

    function formatDateYYYYMMDD(d) {
      const year  = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day   = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    /*******************************************************************************
     *                                  RENDER LOGIC                                *
     ******************************************************************************/
    // Current Price
    function renderCurrentPrice() {
      const now = new Date();
      // Find a period that covers the current time
      const currentPeriod = todayData.find(item => {
        const start = new Date(item.valid_from);
        const end   = new Date(item.valid_to);
        return start <= now && end > now;
      });
      if (!currentPeriod) {
        priceEl.innerText = 'No current price data.';
        timestampEl.innerText = '';
        return;
      }
      priceEl.innerText = `Current Price: ${currentPeriod.value_inc_vat.toFixed(2)} p/kWh`;
      const startTimeStr = new Date(currentPeriod.valid_from)
        .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const endTimeStr   = new Date(currentPeriod.valid_to)
        .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      timestampEl.innerText = `Valid: ${startTimeStr} - ${endTimeStr}`;
    }

    // Metrics
    function renderMetrics() {
      if (!todayData.length) {
        minPriceEl.innerText = '-';
        maxPriceEl.innerText = '-';
        avgPriceEl.innerText = '-';
        return;
      }
      let minPrice = Infinity;
      let maxPrice = -Infinity;
      let sumPrice = 0;
      for (const item of todayData) {
        const p = item.value_inc_vat;
        if (p < minPrice) minPrice = p;
        if (p > maxPrice) maxPrice = p;
        sumPrice += p;
      }
      const avgPrice = sumPrice / todayData.length;
      minPriceEl.innerText = `${minPrice.toFixed(2)} p/kWh`;
      maxPriceEl.innerText = `${maxPrice.toFixed(2)} p/kWh`;
      avgPriceEl.innerText = `${avgPrice.toFixed(2)} p/kWh`;
    }

    // Chart
    function renderChart() {
      const cWidth  = chartCanvas.clientWidth;
      const cHeight = chartCanvas.clientHeight;

      // Adjust internal resolution
      chartCanvas.width  = cWidth  * window.devicePixelRatio;
      chartCanvas.height = cHeight * window.devicePixelRatio;
      chartCtx.scale(window.devicePixelRatio, window.devicePixelRatio);

      chartPoints = []; // clear old

      if (!todayData.length) {
        chartCtx.clearRect(0, 0, cWidth, cHeight);
        chartCtx.fillStyle = '#fff';
        chartCtx.fillText('No data for chart.', 10, 30);
        return;
      }

      // Sort by time
      todayData.sort((a, b) => new Date(a.valid_from) - new Date(b.valid_from));

      // Min / max time & price
      const minTime = new Date(todayData[0].valid_from).getTime();
      const maxTime = new Date(todayData[todayData.length - 1].valid_to).getTime();
      let minP = Infinity, maxP = -Infinity;
      for (const d of todayData) {
        if (d.value_inc_vat < minP) minP = d.value_inc_vat;
        if (d.value_inc_vat > maxP) maxP = d.value_inc_vat;
      }
      const timeRange  = maxTime - minTime || 1;
      const priceRange = maxP - minP || 1;

      // Clear
      chartCtx.clearRect(0, 0, cWidth, cHeight);

      // Prepare path
      chartCtx.strokeStyle = '#FF00E5';
      chartCtx.lineWidth   = 2;
      chartCtx.beginPath();

      todayData.forEach((item, i) => {
        const t = new Date(item.valid_from).getTime();
        const xNorm = (t - minTime) / timeRange; // 0..1
        const x = xNorm * cWidth;

        const yNorm = (item.value_inc_vat - minP) / priceRange; // 0..1
        const y = cHeight - yNorm * cHeight;

        // Store for hover
        chartPoints.push({
          x, y, price: item.value_inc_vat, 
          from: item.valid_from, to: item.valid_to
        });

        if (i === 0) {
          chartCtx.moveTo(x, y);
        } else {
          chartCtx.lineTo(x, y);
        }
      });
      chartCtx.stroke();

      // Draw circles
      chartCtx.fillStyle = '#FF00E5';
      chartPoints.forEach(pt => {
        chartCtx.beginPath();
        chartCtx.arc(pt.x, pt.y, 3, 0, 2 * Math.PI);
        chartCtx.fill();
      });

      // Label min / max
      chartCtx.fillStyle = '#FFFFFF';
      chartCtx.fillText(`Min: ${minP.toFixed(2)}`, 10, cHeight - 10);
      chartCtx.fillText(`Max: ${maxP.toFixed(2)}`, 10, 20);
    }

    // Chart hover
    function onCanvasHover(e) {
      const rect = chartCanvas.getBoundingClientRect();
      let clientX, clientY;
      if (e.touches && e.touches.length) {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
      } else {
        clientX = e.clientX;
        clientY = e.clientY;
      }
      const x = clientX - rect.left;
      const y = clientY - rect.top;

      // find closest point
      let closest = null;
      let minDist = Infinity;
      chartPoints.forEach(pt => {
        const dx = pt.x - x;
        const dy = pt.y - y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < minDist) {
          minDist = dist;
          closest = pt;
        }
      });

      if (closest && minDist < 25) {
        // Show tooltip
        chartTooltipEl.innerText = `${closest.price.toFixed(2)} p/kWh`;
        chartTooltipEl.style.left = (rect.left + closest.x + 10) + 'px';
        chartTooltipEl.style.top  = (rect.top  + closest.y - 20) + 'px';
        chartTooltipEl.style.opacity = 1;
      } else {
        chartTooltipEl.style.opacity = 0;
      }
    }

    // Table
    function renderPriceTable() {
      priceTableBodyEl.innerHTML = '';
      const now = new Date();
      const futureIntervals = todayData.filter(d => {
        const end = new Date(d.valid_to);
        return end > now;
      });
      if (!futureIntervals.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 3;
        cell.innerText = 'No more intervals today.';
        row.appendChild(cell);
        priceTableBodyEl.appendChild(row);
        return;
      }
      futureIntervals.forEach(item => {
        const row = document.createElement('tr');

        const fromStr = new Date(item.valid_from)
          .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const toStr   = new Date(item.valid_to)
          .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const price   = item.value_inc_vat;

        const fromCell  = document.createElement('td');
        fromCell.innerText = fromStr;
        const toCell    = document.createElement('td');
        toCell.innerText   = toStr;
        const priceCell = document.createElement('td');
        priceCell.innerText= price.toFixed(2);

        // color-coded row
        if (price < 15) {
          row.classList.add('price-good');
        } else if (price < 25) {
          row.classList.add('price-ok');
        } else {
          row.classList.add('price-bad');
        }

        row.appendChild(fromCell);
        row.appendChild(toCell);
        row.appendChild(priceCell);
        priceTableBodyEl.appendChild(row);
      });
    }

    // Tomorrow preview
    function renderTomorrow() {
      if (!tomorrowData.length) {
        tomorrowInfoEl.innerText = 'No data for tomorrow yet.';
        return;
      }
      let minP = Infinity, maxP = -Infinity;
      for (const item of tomorrowData) {
        const p = item.value_inc_vat;
        if (p < minP) minP = p;
        if (p > maxP) maxP = p;
      }
      tomorrowInfoEl.innerText = 
        `Min: ${minP.toFixed(2)} p/kWh, Max: ${maxP.toFixed(2)} p/kWh`;
    }

    /*******************************************************************************
     *                          DEBUG LOG UTILITIES                                *
     ******************************************************************************/
    function showDebug(msg) {
      debugLogEl.style.display = 'block';
      debugLogEl.textContent = typeof msg === 'object' ? JSON.stringify(msg) : String(msg);
      console.error(msg);
    }
    function hideDebug() {
      debugLogEl.style.display = 'none';
      debugLogEl.textContent = '';
    }

    /*******************************************************************************
     *                           MAIN WORKFLOW                                     *
     ******************************************************************************/
    async function fetchAndRenderAll() {
      showDebug(`Fetching data for region: ${regionCode}...`);
      try {
        const data = await fetchAgileData();
        hideDebug();
        if (!data || !data.results) {
          throw new Error('No data returned from API.');
        }

        splitTodayAndTomorrowData(data.results);

        renderCurrentPrice();
        renderMetrics();
        renderChart();
        renderPriceTable();
        renderTomorrow();

      } catch (err) {
        showDebug(err);
        priceEl.innerText = 'Error loading price data.';
      }
    }

    // Initial run
    fetchAndRenderAll();
    setInterval(fetchAndRenderAll, 30 * 60 * 1000); // every 30 minutes
  </script>
</body>
</html>
